!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).SimpleSpreadsheet={})}(this,function(e){"use strict";class SpreadsheetError extends Error{}class ParsingError extends SpreadsheetError{constructor(e){super(e)}toString(){return`Syntax error: ${this.message}`}}class RuntimeError extends SpreadsheetError{constructor(e){super(e)}toString(){return`Evaluation error: ${this.message}`}}const t=Object.freeze({EOF:"EOF",WHITESPACE:"WHITESPACE",PLUS:"PLUS",MINUS:"MINUS",STAR:"STAR",SLASH:"SLASH",LPAREN:"LPAREN",RPAREN:"RPAREN",COLON:"COLON",EQUALS:"EQUALS",COMMA:"COMMA",NUMBER:"NUMBER",STRING:"STRING",IDENTIFIER:"IDENTIFIER"});class Tokenizer{constructor(){this.rules={"\\d+(?:\\.\\d+)?":t.NUMBER,"[a-zA-Z]\\w+":t.IDENTIFIER,"\\s+":t.WHITESPACE,"\\+":t.PLUS,"-":t.MINUS,"\\*":t.STAR,"\\/":t.SLASH,"\\(":t.LPAREN,"\\)":t.RPAREN,"=":t.EQUALS,":":t.COLON,",":t.COMMA,'\\"(?:[^"\\\\]|\\\\.)*\\"':t.STRING,$:t.EOF}}begin(e){return this.remaining=e,this}next(){const e=this.peek();return this.remaining=this.remaining.slice(e.value.length),e}peek(){for(let e in this.rules){const t=this.remaining.match(new RegExp("^"+e));if(null!==t)return{type:this.rules[e],value:t[0]}}throw new ParsingError(`Unknown token '${this.remaining}'`)}rest(){const e=this.remaining;return this.remaining="",e}}class Expression{}class Value extends Expression{constructor(e){super(),this.value=e}toString(){return this.value.constructor===String?`"${this.value}"`:`${this.value}`}}class Reference extends Expression{constructor(e,t){super(),this.col=e,this.row=t}toString(){return`Reference(${this.col}${this.row})`}}class BinaryOp extends Expression{constructor(e,t,r){super(),this.left=e,this.op=t,this.right=r}toString(){return`BinaryOp(${this.left} ${this.op} ${this.right})`}}class UnaryOp extends Expression{constructor(e,t){super(),this.op=e,this.value=t}toString(){return`UnaryOp(${this.op} ${this.value})`}}class FunctionCall extends Expression{constructor(e,t){super(),this.functionName=e,this.args=t}toString(){return`FunctionCall(${this.functionName}, ${this.args.join(", ")})`}}class Range extends Expression{constructor(e,t){super(),this.from=e,this.to=t}toString(){return`Range(${this.from}, ${this.to})`}}function r(e,t){const r=[];for(let s of n(i(e.col),i(t.col)))for(let o of n(e.row,t.row))r.push({col:a(s),row:o});return r}function n(e,t){return e<=t?Array.from({length:t-e+1},(t,r)=>r+e):Array.from({length:e-t+1},(t,r)=>e-r)}function s(e){const t=e.match(/^([A-Za-z]+)(\d+)$/);return null===t?null:{col:t[1],row:parseInt(t[2])}}function o(e,t){return`${e}${t}`}function i(e){return e.charCodeAt(0)-65}function a(e){return String.fromCharCode(e+65)}var u=Object.freeze({positionsInRange:r,parseRange:function(e){const[t,r]=e.split(":");return{from:s(t),to:s(r)}},makeRange:function(e,t){return`${e}:${t}`},parsePosition:s,makePosition:o,columnIndex:i,columnLetter:a});class Parser{constructor(e){this.tokens=e}parse(e){if(null==e||e.constructor!==String)return{parsed:new Value(e),references:[]};this.tokens.begin(e);const t=this.parseCell();return{parsed:t,references:[...new Set(this._getReferencesIn(t))]}}parseCell(){if(this.tokens.remaining.startsWith("=")){this._expectAny(t.EQUALS);const e=this.parseExpression();return this._require(t.EOF),e}return this.parseSimpleValue()}parseSimpleValue(){const e=this.tokens.rest();return e.match(/^[+-]?\d+(?:\.\d+)?$/)?new Value(parseFloat(e)):new Value(e)}parseExpression(){return this.parseTerm()}parseTerm(){let e,r=this.parseFactor();for(;null!==(e=this._expectAny(t.PLUS,t.MINUS));)r=new BinaryOp(r,e.value,this.parseFactor());return r}parseFactor(){let e,r=this.parseUnary();for(;null!==(e=this._expectAny(t.STAR,t.SLASH));)r=new BinaryOp(r,e.value,this.parseUnary());return r}parseUnary(){let e=this._expectAny(t.PLUS,t.MINUS);return null!==e?new UnaryOp(e.value,this.parseUnary()):this.parseValue()}parseValue(){if(this._expectAny(t.LPAREN))return this._parseParenthesized();const e=this._expectAny(t.NUMBER);if(null!==e)return this._parseNumber(e);const r=this._expectAny(t.STRING);if(null!==r)return this._parseString(r);const n=this._require(t.IDENTIFIER);return null!==n&&this._expectAny(t.COLON)?this._parseRangeReference(n):this._expectAny(t.LPAREN)?this._parseFunctionCall(n):this._parseReference(n.value)}_parseParenthesized(){const e=this.parseExpression();return this._require(t.RPAREN),e}_parseNumber(e){return new Value(parseFloat(e.value))}_parseString(e){const t=e.value.substring(1,e.value.length-1).replace(/\\(.)/g,"$1");return new Value(t)}_parseRangeReference(e){const r=this._require(t.IDENTIFIER),n=this._parseReference(e.value),s=this._parseReference(r.value);return new Range(n,s)}_parseFunctionCall(e){let r=e.value;do{const e=this.parseArguments();r=new FunctionCall(r,e)}while(this._expectAny(t.LPAREN));return r}_parseReference(e){const t=s(e);if(null===t)throw new ParsingError(`Invalid format of cell reference: ${e}`);return new Reference(t.col,t.row)}parseArguments(){const e=[];for(;!this._expectAny(t.RPAREN);)0!=e.length&&this._require(t.COMMA),e.push(this.parseExpression());return e}_expectAny(...e){const t=this._next();return e.includes(t.type)?(this.tokens.next(),t):null}_require(e){const t=this._expectAny(e);if(null===t)throw new ParsingError(`Expected ${e}, got ${this.tokens.peek().type} instead`);return t}_next(){let e=this.tokens.peek();for(;e.type===t.WHITESPACE;)this.tokens.next(),e=this.tokens.peek();return e}_getReferencesIn(e){switch(e.constructor){case Value:return[];case Reference:return[o(e.col,e.row)];case UnaryOp:return this._getReferencesIn(e.value);case BinaryOp:return[...this._getReferencesIn(e.left),...this._getReferencesIn(e.right)];case FunctionCall:return e.args.flatMap(e=>this._getReferencesIn(e));case Range:return r(e.from,e.to).map(e=>o(e.col,e.row));default:throw new ParsingError(`Unknown expression type: ${typeof e}`)}}}class Evaluator{constructor(){this._currentCellStack=[]}evaluateCellAt(e,t,r){this._currentCellStack.push({position:e,references:new Set});const n=this._evaluateCell(t,r);return n}evaluateQuery(e,t){return this._evaluateCell(e,t)}_evaluateCell(e,t){switch(e.constructor){case Value:return e.value;case Reference:return this._evaluateReference(o(e.col,e.row),t);case UnaryOp:return this._evaluateUnary(e.op,e.value,t);case BinaryOp:return this._evaluateBinary(e.left,e.op,e.right,t);case FunctionCall:return this._evaluateFunction(e.functionName,e.args,t);case Range:throw new RuntimeError("Range references are allowed only as arguments of functions");default:throw new RuntimeError(`Unknown expression type: ${typeof e}`)}}_evaluateReference(e,t){try{const r=t.getValue(e),n=this._currentCellStack[this._currentCellStack.length-1];return n&&n.references.add(e),r}catch(t){throw t instanceof ParsingError?new RuntimeError(`Error in referenced cell: ${e}`):t}}_evaluateExpression(e,t){switch(e.constructor){case Range:return this._evaluateRange(e.from,e.to,t);default:return this._evaluateCell(e,t)}}_evaluateUnary(e,t,r){const n=this._evaluateCell(t,r);switch(e){case"+":return n;case"-":return-n;default:throw new RuntimeError(`Unknown unary operator: '${e}'`)}}_evaluateBinary(e,t,r,n){const s=this._evaluateCell(e,n),o=this._evaluateCell(r,n);switch(t){case"+":return s+o;case"-":return s-o;case"*":return s*o;case"/":return s/o;default:throw new RuntimeError(`Unknown binary operator: '${t}'`)}}_evaluateFunction(e,t,r){const n=t.map(e=>this._evaluateExpression(e,r)),s=r.getFunction(e);try{return s(...n)}catch(t){throw new RuntimeError(`Error in function ${e}: ${t}`)}}_evaluateRange(e,t,n){return r(e,t).map(e=>o(e.col,e.row)).map(e=>this._evaluateReference(e,n))}}class TwoWayMap{constructor(){this._nodesFrom={},this._nodesTo={}}getFrom(e){return this._nodesFrom[e]}getTo(e){return this._nodesTo[e]}addNode(e,t){this._addToNode(this._nodesFrom,e,t),this._addToNode(this._nodesTo,t,e)}removeNode(e,t){this._removeFromNode(this._nodesFrom,e,t),this._removeFromNode(this._nodesTo,t,e)}removeNodesFrom(e){this._removeNodes(this._nodesFrom,this._nodesTo,e)}removeNodesTo(e){this._removeNodes(this._nodesTo,this._nodesFrom,e)}traverseIncoming(e,t){t(e);const r=this.getTo(e);if(r)for(let e of r)this.traverseIncoming(e,t)}_addToNode(e,t,r){e[t]||(e[t]=[]),e[t].push(r)}_removeFromNode(e,t,r){const n=e[t].indexOf(r);n>-1&&e[t].splice(n,1)}_removeNodes(e,t,r){const n=e[r];for(let e of n)this._removeFromNode(t,e,r);delete e[r]}toString(){if(0===Object.entries(this._nodesFrom).length&&0===Object.entries(this._nodesTo).length)return"{ }";let e="{\n    ";for(let t in this._nodesFrom)e+=`${t} => [${this._nodesFrom[t].join(", ")}]; `;e+="\n    ";for(let t in this._nodesTo)e+=`${t} <= [${this._nodesTo[t].join(", ")}]; `;return e+="\n}"}}class Environment{constructor(e={},t={}){this.cells=e,this.functions=t,this._parser=new Parser(new Tokenizer),this._evaluator=new Evaluator,this._expressionsCache={},this._valuesCache={},this._referencesMap=new TwoWayMap}getText(e){return this.cells.hasOwnProperty(e)?this.cells[e].toString():""}setText(e,t){this.cells[e]=t,delete this._expressionsCache[e],this._referencesMap.traverseIncoming(e,e=>delete this._valuesCache[e]),this._referencesMap.getFrom(e)&&this._referencesMap.removeNodesFrom(e)}getExpression(e){if(this._expressionsCache.hasOwnProperty(e))return this._expressionsCache[e];const t=this.cells.hasOwnProperty(e)?this.cells[e]:null,{parsed:r,references:n}=this._parser.parse(t);this._expressionsCache[e]=r;for(let t of n)this._referencesMap.addNode(e,t);return r}getValue(e){if(this._valuesCache.hasOwnProperty(e))return this._valuesCache[e];const t=this._evaluator.evaluateCellAt(e,this.getExpression(e),this);return this._valuesCache[e]=t,t}evaluateQuery(e){const{parsed:t,_:r}=this._parser.parse(e);return this._evaluator.evaluateQuery(t,this)}getFunction(e){if(void 0===this.functions[e])throw new RuntimeError(`Unknown function: ${e} is not a function`);return this.functions[e]}}const l={SUM:(...e)=>{let t=0;for(let r of e.flat())if("number"==typeof r)t+=r;else if(null!=r)throw new Error(`${typeof r} is not a valid argument to SUM(). Expected number, number[], null or undefined.`);return t},AVERAGE:(...e)=>{let t=0,r=0;for(let n of e.flat())if("number"==typeof n)t+=n,r++;else if(null!=n)throw new Error(`${typeof n} is not a valid argument to AVERAGE().`);return t/r}};e.Helpers=u,e.ParsingError=ParsingError,e.RuntimeError=RuntimeError,e.Spreadsheet=class Spreadsheet{constructor(e={},t=l){this.cells=e,this._environment=new Environment(this.cells,t)}text(e){return this._environment.getText(e)}set(e,t){this._environment.setText(e,t)}value(e){return this._environment.getValue(e)}query(e){return this._environment.evaluateQuery(e)}},e.SpreadsheetError=SpreadsheetError,e.builtinFunctions=l,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=simple-spreadsheet.min.js.map
